#!/bin/bash

# Validation of the number of arguments
if [ "$#" -ne 1 ]; then
    echo "Usage: $0 <URL>"
    echo "Example: $0 http://example.com"
    exit 1
fi

# URL validation
if [[ ! "$1" =~ ^https?:// ]]; then
    echo "Invalid URL. It must start with http:// or https://"
    exit 1
fi

echo "Retrieving information from the URL: $1"

# Function to make a request and format JSON using python -m json.tool
request_and_format() {
    local url=$1
    local endpoint=$2
    local response=$(curl -s "$url$endpoint")

    # Check if the curl command was successful
    if [ $? -ne 0 ]; then
        echo "Error: Unable to retrieve data from $url$endpoint"
        exit 1
    fi

    echo "$response" | python -m json.tool
}

# Function to extract user data from JSON
extract_users() {
    local data_json=$1
    jq -r '.data[] | select(.type == "users") | [.id, .attributes.name, .attributes.username, .attributes.email, .attributes.group_names] | @csv' <<< "$data_json" | sed 's/"//g'
}

# Extract and display site configuration
config_response=$(request_and_format "$1" "/api/index.php/v1/config/application?public=true")

# Extract and display user data
users_response=$(request_and_format "$1" "/api/index.php/v1/users?public=true")

# Display the retrieved information in a more structured way
echo -e "\nRetrieved information:"
echo -e "Site Configuration:"
sitename=$(echo "$config_response" | grep -oP '(?<="sitename": ")[^"]*')
editor=$(echo "$config_response" | grep -oP '(?<="editor": ")[^"]*')
captcha=$(echo "$config_response" | grep -oP '(?<="captcha": )[^,]*')
access=$(echo "$config_response" | grep -oP '(?<="access": )[^,]*')
debug=$(echo "$config_response" | grep -oP '(?<="debug": )[^,]*')
dbtype=$(echo "$config_response" | grep -oP '(?<="dbtype": ")[^"]*')
host=$(echo "$config_response" | grep -oP '(?<="host": ")[^"]*')
user=$(echo "$config_response" | grep -oP '(?<="user": ")[^"]*')
password=$(echo "$config_response" | grep -oP '(?<="password": ")[^"]*')
dbname=$(echo "$config_response" | grep -oP '(?<="db": ")[^"]*')
dbprefix=$(echo "$config_response" | grep -oP '(?<="dbprefix": ")[^"]*')
dbencryption=$(echo "$config_response" | grep -oP '(?<="dbencryption": )[^,]*')

echo -e "  Site name: $sitename"
echo -e "  Editor: $editor"
echo -e "  Captcha: $captcha"
echo -e "  Access: $access"
echo -e "  Debug status: $debug"
echo -e "\nDatabase Info:"
echo -e "  DB type: $dbtype"
echo -e "  DB host: $host"
echo -e "  DB user: $user"
echo -e "  DB password: $password"
echo -e "  DB name: $dbname"
echo -e "  DB prefix: $dbprefix"
echo -e "  DB encryption: $dbencryption"

echo -e "\nUsers:"
extract_users "$users_response" | while IFS=, read -r id name username email group_names; do
    echo "[$id] $name ($username) - $email - $group_names"
